<?php/** * Created by PhpStorm. * User: Administrator * Date: 2018/4/7 0007 * Time: 11:01 */namespace app\rep\controller;use agent\AgentPath;use think\Db;class Machine extends Common{    /**     * 首页     */    public function index()    {        $page = input('page',1);        $status = input("status");        $code = input("code");        $map = [];        if (intval($status) != 0) {            $map["m.machine_status"] = $status;        }        if (trim($code) != '') {            $map["m.machine_code"] = ["like", "%$code%"];        }        $map["m.machine_rep_id"] = $this->rep_id;        $machine_list = Db::name('machine')            ->alias("m")            ->join('agent a', 'a.agent_id = m.machine_agent_id', 'left')            ->order('m.machine_id DESC')            ->field("m.*,a.agent_name")            ->where($map)            ->limit(($page-1)*$this->pageNum,$this->pageNum)->select();        if(!$machine_list) return returnState(100,'没有数据！');        return returnState(200,'获取成功',['machine_list' => $machine_list]);    }    /**     * 货道列表     */    public function machine_channel()    {        $machine_id = input('machine_id');        if (intval($machine_id) == 0) {            return returnState(100,"设备ID获取失败，请重新进入页面");        }        $map['mc.channel_machine_id'] = $machine_id;        $map['m.machine_agent_id'] = AgentPath::get_path($this->rep_agent_id);        $channel_list = Db::name('machine_channel')            ->alias('mc')            ->join('machine m','mc.channel_machine_id = m.machine_id','left')            ->join('goods g', 'g.goods_id = mc.channel_goods_id', 'left')            ->where($map)            ->field('mc.*,g.goods_name goods_name,g.goods_id goods_id,g.goods_type goods_type')            ->order('channel_name asc')            ->select();        if(!$channel_list) return returnState(100,'没有数据！');        return returnState(200,'获取成功',['channel_list' => $channel_list]);    }}